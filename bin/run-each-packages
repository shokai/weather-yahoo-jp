#!/usr/bin/env node
"use strict";

var path = require("path");
var fs = require("fs");
var exec = require("child_process").exec;
var async = require("async");

var pkgs = fs.readdirSync(path.resolve(__dirname + "/../packages/"));
var each = async.eachSeries;

var args = process.argv.slice(2);
if(args[0] === "--parallel"){
  each = async.each;
  args.shift();
}
var cmd = args.join(' ');

console.log("command:  " + cmd);
console.log("packages: " + JSON.stringify(pkgs));

if(cmd.length < 1) process.exit(0);

each(pkgs, function(pkg, next){

  var pkgdir = path.resolve(__dirname + "/../packages", pkg);
  var _exec = exec(cmd, {cwd: pkgdir}, next);
  _exec.stdout.on("data", function(data){
    console.log("=== " + pkgdir + " ===");
    process.stdout.write(data);
  });

}, function(err, res){
  if(err) console.error(err);
});
